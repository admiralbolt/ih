<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ih.workflow &mdash; Image Harvest 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Image Harvest 1.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Image Harvest</a>
        <span class="navbar-text navbar-version pull-left"><b>1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_script_core1.html">Core Processing Example #1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_script_core2.html">Core Processing Example #2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_script_color1.html">Color Filter In Depth #1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_script_seed.html">Seed Processing Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_script_camera1.html">Camera Processing Example #1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_script_camera2.html">Camera Processing Example #2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_workflow_1.html">Workflow Example #1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_workflow_2.html">OSG Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_workflow_2.html#creating-the-ih-distribution">Creating the ih Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ex_workflow_2.html#creating-ssh-keys">Creating ssh Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arkansas_workshop_july_2015.html">Arkansas Workshop July 2015</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../processing.html">Image Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viewer.html">Image Processing Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indexing.html">Image Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflowimage.html">Image Processing Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflowstats.html">Statistics Workflows</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <h1>Source code for ih.workflow</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of Image Harvest.</span>

<span class="sd">Image Harvest is free software: you can redistribute it and/or modify</span>
<span class="sd">it under the terms of the GNU General Public License as published by</span>
<span class="sd">the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">(at your option) any later version.</span>

<span class="sd">Image Harvest is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">GNU General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public License</span>
<span class="sd">along with Image Harvest.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">conf</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">ih.validator</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">xml.dom.minidom</span>
<span class="kn">from</span> <span class="nn">Pegasus.DAX3</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">Workflow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic workflow creation class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobhome</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :param jobhome: The base directory for job submission.</span>
<span class="sd">            :type jobhome: str</span>

<span class="sd">            Creates a Workflow class based on the input directory.  Only loads and</span>
<span class="sd">            validates the config file by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">jobhome</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dax</span> <span class="o">=</span> <span class="n">ADAG</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadInputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads the input files into the appropriate variables</span>
<span class="sd">            This should be overloaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_isFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">imtype</span><span class="p">,</span> <span class="n">inout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenience function to check if a given file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">imtype</span><span class="p">][</span><span class="n">inout</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_isJob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenience function to check if a given job exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_isExecutable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenience function to check if a given executable exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_createSetup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the base structure for job submission.  Everything is contained</span>
<span class="sd">            within a folder based on the current timestamp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;input/templates&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/templates&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/staging&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/staging&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_addFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">imtype</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">derivedPath</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Adds the inputted file to the dax, as well as the internal variable self.files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dax</span> <span class="o">=</span> <span class="n">dax</span> <span class="k">if</span> <span class="n">dax</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">imtype</span><span class="p">,</span> <span class="n">inout</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">imtype</span><span class="p">][</span><span class="n">inout</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">inout</span> <span class="o">==</span> <span class="s">&quot;input&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">imtype</span><span class="p">][</span><span class="n">inout</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">imtype</span><span class="p">][</span><span class="n">inout</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">addPFN</span><span class="p">(</span><span class="n">PFN</span><span class="p">(</span><span class="s">&quot;file://&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;%20&quot;</span><span class="p">),</span> <span class="s">&quot;local&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">derivedPath</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">imtype</span><span class="p">][</span><span class="n">inout</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s">&quot;derivedPath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">derivedPath</span>
                <span class="n">dax</span><span class="o">.</span><span class="n">addFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">imtype</span><span class="p">][</span><span class="n">inout</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_addJob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">dax</span> <span class="o">=</span> <span class="n">dax</span> <span class="k">if</span> <span class="n">dax</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isJob</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">dax</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="s">&quot;osg-wrapper.sh&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span>
            <span class="n">dax</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s">&quot;ih.tar.gz&quot;</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">],</span> <span class="n">link</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">],</span> <span class="n">link</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="n">transfer</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;transfer&quot;</span><span class="p">])</span>
            <span class="n">arglist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;./ih-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;version&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;/scripts/&quot;</span> <span class="o">+</span> <span class="n">executable</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
                <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                    <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">arg</span><span class="p">])][</span><span class="s">&quot;file&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                    <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">arg</span><span class="p">])][</span><span class="s">&quot;file&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                        <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="n">arg</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span><span class="o">.</span><span class="n">addArguments</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                    <span class="n">dax</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">],</span> <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">depend</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">Namespace</span><span class="o">.</span><span class="n">PEGASUS</span><span class="p">,</span> <span class="s">&quot;label&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">walltime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">dax</span><span class="p">][</span><span class="n">jobname</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">Namespace</span><span class="o">.</span><span class="n">GLOBUS</span><span class="p">,</span> <span class="s">&quot;maxwalltime&quot;</span><span class="p">,</span> <span class="n">walltime</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates a new pegasus submission directory based on the current timestamp,</span>
<span class="sd">            and populates it with all required information to submit a pegasus job.</span>
<span class="sd">            This function should be overloaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>


<div class="viewcode-block" id="Statistics"><a class="viewcode-back" href="../../workflowstats.html#ih.workflow.Statistics">[docs]</a><span class="k">class</span> <span class="nc">Statistics</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class specifically for statistics workflow</span>
<span class="sd">        validation and submission.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobhome</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">validOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Statistics</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">jobhome</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">configFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statsfile</span> <span class="o">=</span> <span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">statsFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">outputdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validOnly</span> <span class="o">=</span> <span class="n">validOnly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputFiles</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_getImageTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select distinct imtype from images&quot;</span><span class="p">)]</span>


    <span class="k">def</span> <span class="nf">_loadInputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">Statistics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statsfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">validOnly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">rawFiles</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_copyFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Copies all input files to the correct location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/stats&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/stats&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statsfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/templates/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statsfile</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all files (input and output) into the dax and the self.files variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="s">&quot;raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;output.db&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/output.db&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadExecutables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">&quot;linux&quot;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s">&quot;x86_64&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all executables (as specified in the conf) into</span>
<span class="sd">            the dax, as well as the internal self.executables variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ex</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span> <span class="n">installed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ex</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span><span class="o">.</span><span class="n">addPFN</span><span class="p">(</span><span class="n">PFN</span><span class="p">(</span><span class="s">&quot;file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;installdir&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">))</span>
            <span class="c">#if &quot;cluster&quot; in self.config:</span>
            <span class="c">#     self.executables[ex].addProfile(Profile(Namespace.PEGASUS, &quot;clusters.size&quot;, self.config[&quot;cluster&quot;]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">addExecutable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadNotify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&quot;notify&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">When</span><span class="o">.</span><span class="n">AT_END</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/stats/notify.sh&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/stats/notify.sh&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
                <span class="n">notify</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                        #!/bin/bash</span>
<span class="s">                        </span><span class="si">%s</span><span class="s">/notification/email -t </span><span class="si">%s</span><span class="s"> --report=pegasus-analyzer</span>
<span class="s">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;notify&quot;</span><span class="p">][</span><span class="s">&quot;pegasus_home&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;notify&quot;</span><span class="p">][</span><span class="s">&quot;email&quot;</span><span class="p">]))</span>
                <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notify</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/stats/notify.sh&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadJobInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;inputs&quot;</span><span class="p">]):</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;inputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
                <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">extension</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">conf</span><span class="o">.</span><span class="n">fileExtensions</span><span class="p">[</span><span class="n">ftype</span><span class="p">]</span>
                <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="n">ex</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">_loadJobInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;output.db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;output.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;inputs&quot;</span><span class="p">]):</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;inputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
                <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">_createDax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all jobs into the dax, and then writes the dax</span>
<span class="sd">            to input/loc/stats.dax</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serial</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s">&quot;maxwalltime&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;stats&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;maxwalltime&quot;</span><span class="p">]:</span>
                <span class="n">maxwalltime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;maxwalltime&quot;</span><span class="p">][</span><span class="s">&quot;stats&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxwalltime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxwalltime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">]:</span>
                <span class="n">jobname</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--intable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--intable&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--intable&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;images&quot;</span> <span class="k">else</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--intable&quot;</span><span class="p">]</span>
                <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--outtable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--outtable&quot;</span><span class="p">]</span>
                <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;output.db&quot;</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadJobInputs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">depend</span> <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;depends&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="s">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">job</span> <span class="k">else</span> <span class="n">serial</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">serial</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobname</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">serial</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">],</span> <span class="n">depends</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="n">maxwalltime</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/stats.dax&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">writeXML</span><span class="p">(</span><span class="n">wh</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createReplica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the pegasus configuration replica catalog.  input/conf.rc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/conf.rc&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="n">pegasusrc</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                        pegasus.catalog.site = XML</span>
<span class="s">                        pegasus.catalog.site.file = </span><span class="si">%s</span><span class="s">/sites.xml</span>

<span class="s">                        pegasus.condor.logs.symlink = false</span>

<span class="s">                        pegasus.transfer.links = true</span>

<span class="s">                        pegasus.data.configuration = </span><span class="si">%s</span><span class="s"></span>

<span class="s">                        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span><span class="p">))</span>
            <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pegasusrc</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createSites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the pegasus site catalog.  input/sites.xml</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/sites.xml&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">sites</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                &lt;sitecatalog version=&quot;3.0&quot; xmlns=&quot;http://pegasus.isi.edu/schema/sitecatalog&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://pegasus.isi.edu/schema/sitecatalog http://pegasus.isi.edu/schema/sc-3.0.xsd&quot;&gt;</span>
<span class="s">                    &lt;site handle=&quot;local&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                            &lt;head-fs&gt;</span>
<span class="s">                                &lt;scratch&gt;</span>
<span class="s">                                        &lt;shared&gt;</span>
<span class="s">                                            &lt;file-server protocol=&quot;file&quot; url=&quot;file://&quot; mount-point=&quot;</span><span class="si">%s</span><span class="s">&quot;/&gt;</span>
<span class="s">                                            &lt;internal-mount-point mount-point=&quot;</span><span class="si">%s</span><span class="s">&quot;/&gt;</span>
<span class="s">                                        &lt;/shared&gt;</span>
<span class="s">                                    &lt;/scratch&gt;</span>
<span class="s">                                &lt;storage&gt;</span>
<span class="s">                                        &lt;shared&gt;</span>
<span class="s">                                            &lt;file-server protocol=&quot;file&quot; url=&quot;file://&quot; mount-point=&quot;</span><span class="si">%s</span><span class="s">&quot;/&gt;</span>
<span class="s">                                            &lt;internal-mount-point mount-point=&quot;</span><span class="si">%s</span><span class="s">&quot;/&gt;</span>
<span class="s">                                        &lt;/shared&gt;</span>
<span class="s">                                    &lt;/storage&gt;</span>
<span class="s">                            &lt;/head-fs&gt;</span>
<span class="s">                    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/stats/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/stats/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span><span class="p">)</span>
                <span class="n">sites</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                    &lt;/site&gt;</span>
<span class="s">                    &lt;site handle=&quot;condorpool&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                            &lt;head-fs&gt;</span>
<span class="s">                                    &lt;scratch /&gt;</span>
<span class="s">                                    &lt;storage /&gt;</span>
<span class="s">                            &lt;/head-fs&gt;</span>
<span class="s">                &quot;&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sites</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                 &lt;sitecatalog xmlns=&quot;http://pegasus.isi.edu/schema/sitecatalog&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://pegasus.isi.edu/schema/sitecatalog http://pegasus.isi.edu/schema/sc-4.0.xsd&quot; version=&quot;4.0&quot;&gt;</span>

<span class="s">                            &lt;site  handle=&quot;local&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                                &lt;directory type=&quot;shared-scratch&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                                    &lt;file-server operation=&quot;all&quot; url=&quot;file://</span><span class="si">%s</span><span class="s">&quot; /&gt;</span>
<span class="s">                                &lt;/directory&gt;</span>
<span class="s">                                &lt;directory type=&quot;local-storage&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                                    &lt;file-server operation=&quot;all&quot; url=&quot;file://</span><span class="si">%s</span><span class="s">&quot; /&gt;</span>
<span class="s">                                &lt;/directory&gt;</span>
<span class="s">                            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/stats/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/stats/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">][</span><span class="n">namespace</span><span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">][</span><span class="n">namespace</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="s">&quot;path&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">][</span><span class="n">namespace</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">sites</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n\t</span><span class="s">&lt;profile namespace=&quot;</span><span class="si">%s</span><span class="s">&quot; key=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/profile&gt; &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="s">&quot;&lt;/site&gt;&lt;/sitecatalog&gt;&quot;</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createSubmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the pegasus submit script.  submit.sh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/submit.sh&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>

            <span class="n">submit</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                    #!/bin/bash</span>
<span class="s">                    </span><span class="si">%s</span><span class="s"></span>
<span class="s">                    plan=`pegasus-plan </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --conf &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --sites &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --dir &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --output-site local </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --dax &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --randomdir </span><span class="se">\\</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;module unload python/2.7&quot;</span> <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/conf.rc&quot;</span><span class="p">,</span> <span class="s">&quot;condorpool&quot;</span> <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/stats&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/stats.dax&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">submit</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;--cluster horizontal </span><span class="se">\\\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">submit</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                    --submit`</span>

<span class="s">                    status=`echo &quot;$plan&quot; | grep pegasus-status | tr -s &#39; &#39;| cut -d &#39; &#39; -f 6`</span>
<span class="s">                    echo -e &quot;#!/bin/bash</span>
<span class="s">                    pegasus-status -l $status&quot; &gt; status.sh</span>
<span class="s">                    chmod 744 status.sh</span>

<span class="s">                    remove=`echo &quot;$plan&quot; | grep pegasus-remove | tr -s &#39; &#39;| cut -d &#39; &#39; -f 5`</span>
<span class="s">                    echo -e &quot;#!/bin/bash</span>
<span class="s">                    pegasus-remove $remove&quot; &gt; remove.sh</span>
<span class="s">                    chmod 744 remove.sh</span>

<span class="s">                    echo &quot;$plan&quot;</span>
<span class="s">                    echo &quot;Alternatively, you can use the status &amp; remove scripts in the current directory!&quot;</span>

<span class="s">                    &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">submit</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/submit.sh&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Statistics.create"><a class="viewcode-back" href="../../workflowstats.html#ih.workflow.Statistics.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates a new pegasus submission directory based on the current timestamp,</span>
<span class="sd">            and populates it with all required information to submit a pegasus job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="s">&quot;/input/stats/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createSetup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copyFiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadFiles</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadExecutables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadNotify</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createDax</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createReplica</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createSites</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createSubmit</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">return</span>




</div></div>
<div class="viewcode-block" id="ImageProcessor"><a class="viewcode-back" href="../../workflowimage.html#ih.workflow.ImageProcessor">[docs]</a><span class="k">class</span> <span class="nc">ImageProcessor</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class specifically for image processing workflow</span>
<span class="sd">        validation and submission.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobhome</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">validOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :param jobhome: The base directory for job submission.</span>
<span class="sd">            :type jobhome: str</span>

<span class="sd">            Creates a Workflow class based on the input directory.  Loads and validates all input files,</span>
<span class="sd">            and quits out if something doesn&#39;t exist or is defined innapropriately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ImageProcessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">jobhome</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validOnly</span> <span class="o">=</span> <span class="n">validOnly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workfile</span> <span class="o">=</span> <span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">workflowFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metafile</span> <span class="o">=</span> <span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">dbFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">configFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadInputFiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span> <span class="o">=</span> <span class="n">ADAG</span><span class="p">(</span><span class="s">&quot;extract-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadInputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads the input files into the appropriate variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">ImageProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metafile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">validOnly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">conn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">rawFiles</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_getImageTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convenience function to get all image types from the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select distinct imtype from images&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_copyFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Copies all input files to the correct location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/imgproc&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/imgproc&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/templates/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workfile</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/templates/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metafile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/output.db&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;osg&quot;</span><span class="p">][</span><span class="s">&quot;tarball&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;osg&quot;</span><span class="p">][</span><span class="s">&quot;tarball&quot;</span><span class="p">]))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all files (input and output) into the dax and the self.files variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">],</span> <span class="n">wh</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/map.rc&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exInput</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;db&quot;</span><span class="p">:</span> <span class="s">&quot;img.db&quot;</span><span class="p">,</span> <span class="s">&quot;extract.json&quot;</span><span class="p">:</span> <span class="s">&quot;extract.json&quot;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">][</span><span class="s">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="s">&quot;raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">][</span><span class="s">&quot;raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;ih.tar.gz&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/ih-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;version&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.tar.gz&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;ih.tar.gz&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/ih-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;version&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.tar.gz&quot;</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img.db&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/output.db&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img.db&quot;</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/output.db&quot;</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/img2.db&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/img2.db&quot;</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img3.db&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/img3.db&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img3.db&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/img3.db&quot;</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;img.log&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/imgproc.log&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/extract.json&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="s">&quot;extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/extract.json&quot;</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;input&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/rawfiles/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
                <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;img.log file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/imgproc.log pool=</span><span class="se">\&quot;</span><span class="s">local</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;img3.db file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/img3.db pool=</span><span class="se">\&quot;</span><span class="s">local</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">inputImages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;inputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;inputs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s">&quot;image&quot;</span><span class="p">]</span>
                <span class="n">outputImages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="n">z</span><span class="p">][</span><span class="s">&quot;outputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="n">z</span><span class="p">][</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;outputs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s">&quot;image&quot;</span><span class="p">]</span>
                <span class="n">outputFiles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="n">z</span><span class="p">][</span><span class="s">&quot;outputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">conf</span><span class="o">.</span><span class="n">fileExtensions</span><span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="n">z</span><span class="p">][</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;outputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="n">z</span><span class="p">][</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;outputs&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;image&quot;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;none&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="n">z</span><span class="p">][</span><span class="s">&quot;outputs&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select pegasusid, experiment, id, date, imgname, path from images where imtype=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,)):</span>
                    <span class="n">realname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c">#derivedPath = row[&quot;experiment&quot;].replace(&quot; &quot;,&quot;%20&quot;) + &quot;/&quot; + row[&quot;id&quot;].replace(&quot; &quot;,&quot;%20&quot;) + &quot;/&quot; + row[&quot;date&quot;].replace(&quot; &quot;,&quot;%20&quot;) + &quot;/&quot; + type + &quot;/&quot; + row[&quot;imgname&quot;].replace(&quot; &quot;,&quot;%20&quot;) + &quot;/&quot;</span>
                    <span class="n">derivedPath</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;imgname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
                    <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputImages</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">],</span> <span class="n">derivedPath</span> <span class="o">=</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">],</span> <span class="n">derivedPath</span> <span class="o">=</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputImages</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;inputs&quot;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exInput</span><span class="p">[</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span> <span class="o">+</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">)</span>
                        <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span> <span class="o">+</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;%20&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.png pool=</span><span class="se">\&quot;</span><span class="s">local</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputFiles</span><span class="p">:</span>
                        <span class="n">outname</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">outputFiles</span><span class="p">[</span><span class="n">output</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">)</span>
                        <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s">&quot; file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span> <span class="o">+</span> <span class="n">derivedPath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="s">&quot;%20&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">outname</span> <span class="o">+</span> <span class="s">&quot; pool=</span><span class="se">\&quot;</span><span class="s">local</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadNotify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&quot;notify&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">When</span><span class="o">.</span><span class="n">AT_END</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/imgproc/notify.sh&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">When</span><span class="o">.</span><span class="n">AT_END</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/imgproc/notify.sh&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/imgproc/notify.sh&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
                <span class="n">notify</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                        #!/bin/bash</span>
<span class="s">                        </span><span class="si">%s</span><span class="s">/notification/email -t </span><span class="si">%s</span><span class="s"> --report=pegasus-analyzer</span>
<span class="s">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;notify&quot;</span><span class="p">][</span><span class="s">&quot;pegasus_home&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;notify&quot;</span><span class="p">][</span><span class="s">&quot;email&quot;</span><span class="p">]))</span>
                <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">notify</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/input/imgproc/notify.sh&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadExecutables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">&quot;linux&quot;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s">&quot;x86_64&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all executables (as specified in the conf) into</span>
<span class="sd">            the dax, as well as the internal self.executables variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ex</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span> <span class="n">installed</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span> <span class="o">=</span> <span class="n">Executable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ex</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span><span class="o">.</span><span class="n">addPFN</span><span class="p">(</span><span class="n">PFN</span><span class="p">(</span><span class="s">&quot;file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;installdir&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">))</span>
            <span class="c">#if &quot;cluster&quot; in self.config:</span>
            <span class="c">#    val = int(self.config[&quot;cluster&quot;] * conf.valid[ex][&quot;weight&quot;]) if &quot;weight&quot; in conf.valid[ex] else self.config[&quot;cluster&quot;]</span>
            <span class="c">#    self.executables[ex].addProfile(Profile(Namespace.PEGASUS, &quot;clusters.size&quot;, val))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">addExecutable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="o">.</span><span class="n">addExecutable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">ex</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadJobInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;inputs&quot;</span><span class="p">]):</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;inputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawFiles</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
                <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">extension</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">conf</span><span class="o">.</span><span class="n">fileExtensions</span><span class="p">[</span><span class="n">ftype</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">&quot;base&quot;</span><span class="p">:</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="n">ex</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="n">ex</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="nb">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="n">ex</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">_loadJobOutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">save</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;outputs&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">!=</span> <span class="s">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">fileExtensions</span><span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">valid</span><span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">]][</span><span class="s">&quot;outputs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="c">#def _loadJobOutputs(self, job, type, basename):</span>
    <span class="c">#    return dict((output, basename + &quot;_&quot; + output + conf.fileExtensions[conf.valid[job[&quot;executable&quot;]][&quot;outputs&quot;][i]]) for i,output in enumerate(job[&quot;outputs&quot;]) if output != &quot;none&quot;)</span>

    <span class="k">def</span> <span class="nf">_createDax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all jobs into the dax, and then writes the dax</span>
<span class="sd">            to input/workflow.dax</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exDep</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exInput</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">clusternum</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">meancluster</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s">&quot;maxwalltime&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;images&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;maxwalltime&quot;</span><span class="p">]:</span>
                <span class="n">maxwalltime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;maxwalltime&quot;</span><span class="p">][</span><span class="s">&quot;images&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxwalltime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxwalltime</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">save</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="s">&quot;save-steps&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;options&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">]:</span>
            <span class="n">exDep</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span>
            <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{}]</span>
            <span class="n">jobnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">meancluster</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">exNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;depends&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;input&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">imageExtensions</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                    <span class="n">jobnum</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">jobnum</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;cluster&quot;</span><span class="p">]:</span>
                        <span class="n">jobnum</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">exDep</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                    <span class="k">elif</span> <span class="p">((</span><span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">jobnum</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">meancluster</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">extension</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">infile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">realname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;input&quot;</span><span class="p">][</span><span class="n">infile</span><span class="p">][</span><span class="s">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">derivedPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;input&quot;</span><span class="p">][</span><span class="n">infile</span><span class="p">][</span><span class="s">&quot;derivedPath&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">stepnum</span><span class="p">,</span><span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">]):</span>
                    <span class="n">jobname</span> <span class="o">=</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadJobInputs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">derivedPath</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">exNames</span><span class="p">:</span>
                        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadJobOutputs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">derivedPath</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                        <span class="n">exDep</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobname</span><span class="p">)</span>
                        <span class="n">reqFile</span> <span class="o">=</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;inputs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.png&quot;</span>
                        <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]][</span><span class="n">reqFile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">reqFile</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
                        <span class="k">if</span> <span class="s">&quot;--dimfromroi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;arguments&quot;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--dimfromroi&quot;</span><span class="p">]):</span>
                                <span class="n">roiFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--dimfromroi&quot;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">roiFile</span> <span class="o">=</span> <span class="n">derivedPath</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;arguments&quot;</span><span class="p">][</span><span class="s">&quot;--dimfromroi&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.json&quot;</span>
                            <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]][</span><span class="n">roiFile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">roiFile</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="n">save</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadJobOutputs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">derivedPath</span><span class="p">,</span> <span class="n">save</span><span class="p">)</span>
                    <span class="n">depends</span> <span class="o">=</span> <span class="p">[</span><span class="n">derivedPath</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">depend</span> <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;depends&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="s">&quot;depends&quot;</span> <span class="ow">in</span> <span class="n">job</span> <span class="k">else</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;ih-meanshift&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">],</span> <span class="n">depends</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stepnum</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_cluster&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">meancluster</span><span class="p">[</span><span class="nb">type</span><span class="p">])</span> <span class="k">if</span> <span class="s">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="n">maxwalltime</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;executable&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&quot;arguments&quot;</span><span class="p">],</span> <span class="n">depends</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_step&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stepnum</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_cluster&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">])</span> <span class="k">if</span> <span class="s">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="n">maxwalltime</span><span class="p">)</span>


        <span class="n">maprc</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/map.rc&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="n">binDep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aggIn</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">aggIn2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;workflows&quot;</span><span class="p">][</span><span class="nb">type</span><span class="p">][</span><span class="s">&quot;arguments&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&quot;--input&quot;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--input&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&quot;--dimfromroi&quot;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--dimfromroi&quot;</span><span class="p">]</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--dimfromroi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s">&quot;.json&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
                <span class="k">if</span> <span class="s">&quot;histogram-bin&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">imtype</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;histogram-bin&quot;</span><span class="p">][</span><span class="s">&quot;--group&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">imtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;histogram-bin&quot;</span><span class="p">][</span><span class="s">&quot;--group&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]]:</span>
                        <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--colors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;db&quot;</span>
                <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--createdb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s">&quot;.png&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_2.db&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_extract&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="s">&quot;ih-extract-multi&quot;</span><span class="p">,</span> <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">exDep</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">],</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_extract&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="s">&quot;ih-extract-multi&quot;</span><span class="p">,</span> <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="n">arguments</span><span class="p">,</span> <span class="p">[],</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span>
                <span class="n">maprc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span> <span class="o">+</span> <span class="s">&quot; file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span> <span class="o">+</span> <span class="s">&quot; pool=</span><span class="se">\&quot;</span><span class="s">local</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">binDep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_extract&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
                <span class="n">aggIn</span><span class="p">[</span><span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
                <span class="n">aggIn2</span><span class="p">[</span><span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_2.db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="n">aggIn</span><span class="p">[</span><span class="s">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;sql_aggregate1&quot;</span><span class="p">,</span> <span class="s">&quot;ih-sql-aggregate&quot;</span><span class="p">,</span> <span class="n">aggIn</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;img2.db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--output&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;--inputs&quot;</span><span class="p">:</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aggIn</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggIn</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;db&quot;</span><span class="p">])},</span> <span class="n">binDep</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;sql_aggregate1&quot;</span><span class="p">,</span> <span class="s">&quot;ih-sql-aggregate&quot;</span><span class="p">,</span> <span class="n">aggIn</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;img2.db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--output&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;--inputs&quot;</span><span class="p">:</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aggIn</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggIn</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;db&quot;</span><span class="p">])},</span> <span class="n">binDep</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">180</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&quot;histogram-bin&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">]:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;histogram-bin&quot;</span><span class="p">][</span><span class="s">&quot;--group&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addFile</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_hist_bins.json&quot;</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="s">&quot;output&quot;</span><span class="p">)</span>
                <span class="n">maprc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_hist_bins.json&quot;</span> <span class="o">+</span> <span class="s">&quot; file://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_hist_bins.json&quot;</span> <span class="o">+</span> <span class="s">&quot; pool=</span><span class="se">\&quot;</span><span class="s">local</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_hist_bins.json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_hist_bins.json&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;bin_creation&quot;</span><span class="p">,</span> <span class="s">&quot;ih-stats-histogram-bin&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="s">&quot;extract.json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="n">outputs</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--options&quot;</span><span class="p">:</span> <span class="s">&quot;extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;--intable&quot;</span><span class="p">:</span> <span class="s">&quot;images&quot;</span><span class="p">,</span> <span class="s">&quot;--outtable&quot;</span><span class="p">:</span> <span class="s">&quot;histogramBins&quot;</span><span class="p">,</span> <span class="s">&quot;--jsonwrite&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;--overwrite&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">},</span> <span class="p">[</span><span class="s">&quot;sql_aggregate1&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;bin_creation&quot;</span><span class="p">,</span> <span class="s">&quot;ih-stats-histogram-bin&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="s">&quot;extract.json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="n">outputs</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--options&quot;</span><span class="p">:</span> <span class="s">&quot;extract.json&quot;</span><span class="p">,</span> <span class="s">&quot;--intable&quot;</span><span class="p">:</span> <span class="s">&quot;images&quot;</span><span class="p">,</span> <span class="s">&quot;--outtable&quot;</span><span class="p">:</span> <span class="s">&quot;histogramBins&quot;</span><span class="p">,</span> <span class="s">&quot;--jsonwrite&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;--overwrite&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">},</span> <span class="p">[</span><span class="s">&quot;sql_aggregate1&quot;</span><span class="p">],</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">)</span>

            <span class="n">binDep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="nb">map</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;histogram-bin&quot;</span><span class="p">][</span><span class="s">&quot;--group&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">][</span><span class="s">&quot;histogram-bin&quot;</span><span class="p">][</span><span class="s">&quot;--group&quot;</span><span class="p">][</span><span class="n">group</span><span class="p">]:</span>
                    <span class="nb">map</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>

            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;workflows&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clusternum</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;db&quot;</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--copydb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;copydb&quot;</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">][</span><span class="s">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
                    <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">][</span><span class="s">&quot;binfile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">map</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_hist_bins.json&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
                    <span class="n">arguments</span><span class="p">[</span><span class="s">&quot;--bins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;binfile&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_extractBins&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="s">&quot;ih-extract-multi&quot;</span><span class="p">,</span> <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;copydb&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="n">arguments</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;bin_creation&quot;</span><span class="p">],</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">480</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_extractBins&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="s">&quot;ih-extract-multi&quot;</span><span class="p">,</span> <span class="n">exInput</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="n">q</span><span class="p">],</span> <span class="p">{</span><span class="s">&quot;copydb&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="nb">type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;_2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}},</span> <span class="n">arguments</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;bin_creation&quot;</span><span class="p">],</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">480</span><span class="p">)</span>
                    <span class="n">binDep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span> <span class="o">+</span> <span class="s">&quot;_extractBins&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
            <span class="n">aggIn</span><span class="p">[</span><span class="s">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img2.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;sql_aggregate2&quot;</span><span class="p">,</span> <span class="s">&quot;ih-sql-aggregate&quot;</span><span class="p">,</span> <span class="n">aggIn2</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;img3.db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img3.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}},</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--output&quot;</span><span class="p">:</span> <span class="s">&quot;img3.db&quot;</span><span class="p">,</span> <span class="s">&quot;--inputs&quot;</span><span class="p">:</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aggIn</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggIn</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;db&quot;</span><span class="p">])},</span> <span class="n">binDep</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">180</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;sql_aggregate2&quot;</span><span class="p">,</span> <span class="s">&quot;ih-sql-aggregate&quot;</span><span class="p">,</span> <span class="n">aggIn2</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;img3.db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img3.db&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}},</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--output&quot;</span><span class="p">:</span> <span class="s">&quot;img3.db&quot;</span><span class="p">,</span> <span class="s">&quot;--inputs&quot;</span><span class="p">:</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aggIn</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">&quot;file&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aggIn</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;db&quot;</span><span class="p">])},</span> <span class="n">binDep</span><span class="p">,</span> <span class="n">dax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="mi">180</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="s">&quot;histogram-bin&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">indb</span> <span class="o">=</span> <span class="s">&quot;img3.db&quot;</span> <span class="k">if</span> <span class="s">&quot;histogram-bin&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">[</span><span class="s">&quot;extract&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;img.db&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addJob</span><span class="p">(</span><span class="s">&quot;error-log&quot;</span><span class="p">,</span> <span class="s">&quot;ih-error-log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;db&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="n">indb</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}},</span> <span class="p">{</span><span class="s">&quot;output&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="s">&quot;img.log&quot;</span><span class="p">,</span> <span class="s">&quot;transfer&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}},</span> <span class="p">{</span><span class="s">&quot;--db&quot;</span><span class="p">:</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;--output&quot;</span><span class="p">:</span> <span class="s">&quot;output&quot;</span><span class="p">},</span> <span class="p">[</span><span class="s">&quot;sql_aggregate&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/workflow.dax&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">writeXML</span><span class="p">(</span><span class="n">wh</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createExtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the extraction step only dax!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#self._addJob(&quot;extractOnly&quot;, &quot;ih-extract-all&quot;, self.exInput, {}, {&quot;--db&quot;: &quot;db&quot;, &quot;--options&quot;: &quot;extract.json&quot;}, dax = self.exdax)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/extract.dax&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exdax</span><span class="o">.</span><span class="n">writeXML</span><span class="p">(</span><span class="n">wh</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createReplica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the pegasus configuration replica catalog.  input/conf.rc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/conf.rc&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="n">pegasusrc</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                        pegasus.catalog.site = XML</span>
<span class="s">                        pegasus.catalog.site.file = </span><span class="si">%s</span><span class="s">/sites.xml</span>

<span class="s">                        pegasus.condor.logs.symlink = false</span>

<span class="s">                        pegasus.transfer.links = true</span>

<span class="s">                        pegasus.data.configuration = </span><span class="si">%s</span><span class="s"></span>

<span class="s">                        pegasus.dir.storage.mapper = Replica</span>
<span class="s">                        pegasus.dir.storage.mapper.replica = File</span>
<span class="s">                        pegasus.dir.storage.mapper.replica.file = </span><span class="si">%s</span><span class="s">/map.rc</span>
<span class="s">                        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span><span class="p">,</span> <span class="s">&quot;nonsharedfs&quot;</span> <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s">&quot;sharedfs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">pegasusrc</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                    pegasus.stagein.clusters = 4</span>
<span class="s">                    pegasus.stageout.clusters = 4</span>
<span class="s">                    pegasus.transfer.threads = 4</span>
<span class="s">                    pegasus.transfer.lite.threads = 4</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pegasusrc</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createSites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the pegasus site catalog.  input/sites.xml</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/sites.xml&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">userName</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
                <span class="n">sites</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                &lt;sitecatalog version=&quot;4.0&quot; xmlns=&quot;http://pegasus.isi.edu/schema/sitecatalog&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://pegasus.isi.edu/schema/sitecatalog http://pegasus.isi.edu/schema/sc-4.0.xsd&quot;&gt;</span>
<span class="s">                    &lt;site handle=&quot;local&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                        &lt;directory type=&quot;shared-scratch&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                            &lt;file-server operation=&quot;all&quot; url=&quot;file://</span><span class="si">%s</span><span class="s">&quot; /&gt;</span>
<span class="s">                        &lt;/directory&gt;</span>
<span class="s">                        &lt;directory type=&quot;local-storage&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                            &lt;file-server operation=&quot;all&quot; url=&quot;file://</span><span class="si">%s</span><span class="s">&quot; /&gt;</span>
<span class="s">                        &lt;/directory&gt;</span>
<span class="s">                        &lt;profile namespace=&quot;pegasus&quot; key=&quot;SSH_PRIVATE_KEY&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/profile&gt;</span>
<span class="s">                    &lt;/site&gt;</span>
<span class="s">                    &lt;site handle=&quot;stash&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                        &lt;directory type=&quot;shared-scratch&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                            &lt;!-- &lt;file-server operation=&quot;get&quot; url=&quot;stash://</span><span class="si">%s</span><span class="s">&quot;/&gt; --&gt;</span>
<span class="s">                            &lt;file-server operation=&quot;all&quot; url=&quot;scp://</span><span class="si">%s</span><span class="s">@login02.osgconnect.net/</span><span class="si">%s</span><span class="s">&quot;/&gt;</span>
<span class="s">                        &lt;/directory&gt;</span>
<span class="s">                    &lt;/site&gt;</span>
<span class="s">                    &lt;site handle=&quot;isi_workflow&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                        &lt;directory type=&quot;shared-scratch&quot; path=&quot;/nfs/ccg4/scratch-purge-no-backups/workflow.isi.edu/scratch2/</span><span class="si">%s</span><span class="s">/scratch&quot;&gt;</span>
<span class="s">                            &lt;file-server operation=&quot;get&quot; url=&quot;http://workflow.isi.edu/scratch2/</span><span class="si">%s</span><span class="s">/scratch&quot;/&gt;</span>
<span class="s">                            &lt;file-server operation=&quot;put&quot; url=&quot;scp://</span><span class="si">%s</span><span class="s">@workflow.isi.edu/nfs/ccg4/scratch-purge-no-backups/workflow.isi.edu/scratch2/</span><span class="si">%s</span><span class="s">/scratch&quot;/&gt;</span>
<span class="s">                        &lt;/directory&gt;</span>
<span class="s">                    &lt;/site&gt;</span>
<span class="s">                    &lt;site handle=&quot;condorpool&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>



<span class="s">                    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/imgproc/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/imgproc/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;osg&quot;</span><span class="p">][</span><span class="s">&quot;ssh&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/staging/&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/staging/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="n">userName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/staging/&quot;</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">userName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sites</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                 &lt;sitecatalog xmlns=&quot;http://pegasus.isi.edu/schema/sitecatalog&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://pegasus.isi.edu/schema/sitecatalog http://pegasus.isi.edu/schema/sc-4.0.xsd&quot; version=&quot;4.0&quot;&gt;</span>

<span class="s">                            &lt;site  handle=&quot;local&quot; arch=&quot;x86_64&quot; os=&quot;LINUX&quot;&gt;</span>
<span class="s">                                &lt;directory type=&quot;shared-scratch&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                                    &lt;file-server operation=&quot;all&quot; url=&quot;file://</span><span class="si">%s</span><span class="s">&quot; /&gt;</span>
<span class="s">                                &lt;/directory&gt;</span>
<span class="s">                                &lt;directory type=&quot;local-storage&quot; path=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span>
<span class="s">                                    &lt;file-server operation=&quot;all&quot; url=&quot;file://</span><span class="si">%s</span><span class="s">&quot; /&gt;</span>
<span class="s">                                &lt;/directory&gt;</span>
<span class="s">                            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/imgproc/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/imgproc/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/output/&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">][</span><span class="n">namespace</span><span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">][</span><span class="n">namespace</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="s">&quot;path&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;profile&quot;</span><span class="p">][</span><span class="n">namespace</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">sites</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n\t</span><span class="s">&lt;profile namespace=&quot;</span><span class="si">%s</span><span class="s">&quot; key=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/profile&gt; &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">sites</span> <span class="o">+=</span> <span class="s">&quot;&lt;/site&gt;&lt;/sitecatalog&gt;&quot;</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xml</span><span class="o">.</span><span class="n">dom</span><span class="o">.</span><span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_createSubmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the pegasus submit script.  submit.sh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/submit.sh&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wh</span><span class="p">:</span>
            <span class="n">submit</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                    #!/bin/bash</span>
<span class="s">                    if [ &quot;$1&quot; = &quot;--extract-only&quot; ] || [ &quot;$1&quot; = &quot;--extract&quot; ] || [ &quot;$1&quot; = &quot;-e&quot; ]; then</span>
<span class="s">                        DAX=&quot;</span><span class="si">%s</span><span class="s">&quot;</span>
<span class="s">                    else</span>
<span class="s">                        DAX=&quot;</span><span class="si">%s</span><span class="s">&quot;</span>
<span class="s">                    fi</span>
<span class="s">                    plan=`pegasus-plan </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --conf &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --sites &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --dir &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --output-site local </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --dax &quot;$DAX&quot; </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    --randomdir </span><span class="se">\\</span><span class="s"></span>
<span class="s">                    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/extract.dax&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/workflow.dax&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/conf.rc&quot;</span><span class="p">,</span> <span class="s">&quot;condorpool&quot;</span> <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/work/imgproc&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&quot;cluster&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">submit</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;--cluster label </span><span class="se">\\\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s">&quot;osg&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">submit</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;--staging-site stash </span><span class="se">\\\n</span><span class="s">&quot;&quot;&quot;</span>
                <span class="n">submit</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;--staging isi_workflow </span><span class="se">\\\n</span><span class="s">&quot;&quot;&quot;</span>
                <span class="n">submit</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;--cleanup leaf </span><span class="se">\\\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">submit</span> <span class="o">+=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">                    --submit`</span>

<span class="s">                    status=`echo &quot;$plan&quot; | grep pegasus-status | tr -s &#39; &#39;| cut -d &#39; &#39; -f 6`</span>
<span class="s">                    echo -e &quot;#!/bin/bash</span>
<span class="s">                    pegasus-status -l $status&quot; &gt; status.sh</span>
<span class="s">                    chmod 744 status.sh</span>

<span class="s">                    remove=`echo &quot;$plan&quot; | grep pegasus-remove | tr -s &#39; &#39;| cut -d &#39; &#39; -f 5`</span>
<span class="s">                    echo -e &quot;#!/bin/bash</span>
<span class="s">                    pegasus-remove $remove&quot; &gt; remove.sh</span>
<span class="s">                    chmod 744 remove.sh</span>

<span class="s">                    echo &quot;$plan&quot;</span>
<span class="s">                    echo &quot;Alternatively, you can use the status &amp; remove scripts in the current directory!&quot;</span>

<span class="s">                    &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">wh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">submit</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">loc</span> <span class="o">+</span> <span class="s">&quot;/submit.sh&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="ImageProcessor.create"><a class="viewcode-back" href="../../workflowimage.html#ih.workflow.ImageProcessor.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates a new pegasus submission directory based on the current timestamp,</span>
<span class="sd">            and populates it with all required information to submit a pegasus job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;Generating workflow.  Please wait.&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="s">&quot;/input/imgproc/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createSetup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copyFiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadFiles</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadExecutables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadNotify</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createDax</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createExtract</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createReplica</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createSites</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createSubmit</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">return</span>

</div></div>
<div class="viewcode-block" id="ImageLoader"><a class="viewcode-back" href="../../indexing.html#ih.workflow.ImageLoader">[docs]</a><span class="k">class</span> <span class="nc">ImageLoader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should handle all meta-data definitions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">validOnly</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :param template: Path to input template file, should be valid json.</span>
<span class="sd">            :type template: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templatePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&quot;/images.db&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="s">&quot;Path Error: Cannot open output db file. </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&quot;/crawl.log&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">+=</span> <span class="s">&quot;Path Error: Cannot open log file. </span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">ih</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">ImageLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templatePath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> <span class="ow">or</span> <span class="n">validOnly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">printErrors</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;order&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pegasusid&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dictTemplate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Data crawled!&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Use ih-run to submit your jobs.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Directory setup successful!&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Define the required templates in &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Then use ih-run to submit your jobs.&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_dictTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the first of two intermediary dictionaries for crawling.  This relates</span>
<span class="sd">            identifiers in the path, to a specified depth, as well as operators to split</span>
<span class="sd">            the value at that depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&quot;%(\w+)%&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;null&quot;</span><span class="p">]</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;depth&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;split&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&quot;operator&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_loadStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splitPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the second of two intermediary dictionaries for crawling.</span>
<span class="sd">            This utilizes the template created in _dictTemplate, and creates</span>
<span class="sd">            a dictionary with actual values instead of structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">splitPath</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;depth&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;split&quot;</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">operator</span><span class="p">[</span><span class="s">&quot;operator&quot;</span><span class="p">])[</span><span class="n">operator</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">]]</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_loadDataFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads data from a data file.  If the specified key isn&#39;t in the file,</span>
<span class="sd">            write &#39;UNKNOWN&#39; instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keyVal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convertReferences</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;key&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">keyVal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]]:</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]][</span><span class="n">keyVal</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadDataValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads a data value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convertReferences</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">&quot;case&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;case&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;lower&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;case&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;upper&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&quot;translate&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;translations&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;translations&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">val</span><span class="p">]</span>
        <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_loadDataDate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads a date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convertReferences</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
        <span class="n">format</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&quot;%&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">dateFormat</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;format&quot;</span><span class="p">]])</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">format</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_convertReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Replaces all references (&#39;%%&#39;) to actual values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idList</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r&quot;%(\w+)%&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;null&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">idList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;%&quot;</span> <span class="o">+</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="n">structure</span><span class="p">[</span><span class="n">identifier</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_loadData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads all data for a particular path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">splitPath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadStructure</span><span class="p">(</span><span class="n">splitPath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadDataValue</span><span class="p">,</span>
                <span class="s">&quot;file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadDataFile</span><span class="p">,</span>
                <span class="s">&quot;date&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadDataDate</span>
            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;type&quot;</span><span class="p">]](</span><span class="n">final</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">final</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="n">final</span><span class="p">[</span><span class="s">&quot;imtype&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">final</span><span class="p">[</span><span class="s">&quot;imtype&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">final</span><span class="p">[</span><span class="s">&quot;imtype&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">final</span><span class="p">[</span><span class="s">&quot;pegasusid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s">&quot;imtype&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">final</span><span class="p">[</span><span class="s">&quot;imtype&quot;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">final</span>

    <span class="k">def</span> <span class="nf">_loadFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Reads all data from all specified files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filedata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;file&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filedata</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filedata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">],</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rh</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">rh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                            <span class="n">info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">filedata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">]][</span><span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;keyColumn&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s">&quot;valueColumn&quot;</span><span class="p">]]</span>
        <span class="k">return</span>

<div class="viewcode-block" id="ImageLoader.crawl"><a class="viewcode-back" href="../../indexing.html#ih.workflow.ImageLoader.crawl">[docs]</a>    <span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Recursively walks through directories in base, and loads</span>
<span class="sd">            the appropriate data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadFiles</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;base&quot;</span><span class="p">]):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;filetype&quot;</span><span class="p">]):]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;filetype&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loadData</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Could not load file from path: &#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="ImageLoader.write"><a class="viewcode-back" href="../../indexing.html#ih.workflow.ImageLoader.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Writes the data loaded from crawl into csv format based on &#39;order&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&quot;/images.db&quot;</span><span class="p">)</span>
            <span class="n">tablestr</span> <span class="o">=</span> <span class="s">&quot;(pegasusid PRIMARY KEY&quot;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;order&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s">&quot;pegasusid&quot;</span><span class="p">:</span>
                    <span class="n">tablestr</span> <span class="o">+=</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">tablestr</span> <span class="o">+=</span> <span class="s">&quot;)&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS images&quot;</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE images &quot;</span> <span class="o">+</span> <span class="n">tablestr</span><span class="p">)</span>
            <span class="n">writedata</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">writedata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;order&quot;</span><span class="p">]]))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;insert into images &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;order&quot;</span><span class="p">]]))</span> <span class="o">+</span> <span class="s">&quot; values (&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;?,&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="s">&quot;order&quot;</span><span class="p">]))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">writedata</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templatePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">+</span> <span class="s">&quot;/crawl.json&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Call crawl first!&quot;</span>
        <span class="k">return</span>
</div></div>
<span class="k">class</span> <span class="nc">DirectorySetup</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobhome</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            :param jobhome: The base directory to setup a job.</span>
<span class="sd">            :type jobhome: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">jobhome</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">))):</span>
            <span class="k">print</span> <span class="s">&quot;Can&#39;t create job folder, path doesn&#39;t exist!&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">=</span> <span class="n">jobhome</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_makeDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Makes a directory if it doesn&#39;t exist.  Catches and</span>
<span class="sd">            prints out common errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">({</span>
                <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span> <span class="s">&quot;Directory &quot;</span> <span class="o">+</span> <span class="n">dirpath</span> <span class="o">+</span> <span class="s">&quot; already exists!&quot;</span><span class="p">,</span>
                <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">:</span> <span class="s">&quot;You don&#39;t have permission to create directory &quot;</span>  <span class="o">+</span> <span class="n">dirpath</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="p">,</span>
            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="s">&quot;Error for directory &quot;</span> <span class="o">+</span> <span class="n">dirpath</span> <span class="o">+</span> <span class="s">&quot; error:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_makeFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Opens a file to create it, uses append mode</span>
<span class="sd">            so it doesn&#39;t overwrite any existing files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">({</span>

            <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&quot;Unsepcified error for file &quot;</span> <span class="o">+</span> <span class="n">filepath</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates the directory structure needed to submit jobs,</span>
<span class="sd">            and creates empty template files needed for job submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">jobFiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_makeFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobhome</span> <span class="o">+</span> <span class="s">&quot;/input/&quot;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, Avi Knecht.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3a0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>